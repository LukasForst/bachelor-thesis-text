\section{Load balancing decisions with OptaPlanner}\label{sec:load-balancing-optaplanner}

Scheduling system implementation uses OptaPlanner library core in version \inlinedata{7.19.0.Final}\cite{optaplannerDoc}
and it is crucial part of the \inlinecode{core} module and application itself.

\subsection{Scheduling Algorithm}
The OptaPlanner scheduling itself has two main phases.
\textit{Construction heuristics}, that tries to build initial solution in a finite length of time.
This partial solution is not always feasible, 
but it finds it fast and then leaves it to next phase.
\textit{Local search} with metaheuristics that can enhance the partial solution found in previous phase.

OptaPlanner contains various types of construction heuristics (i.e. \textit{first fit}, \textit{weakest fit} and \textit{strongest fit})
as well as local search metaheuristics such as \textit{hill climbing}, \textit{tabu search} and \textit{simulated annealing}.
As the best combination of construction heuristics and local search proved to be \textit{first fit} with \textit{tabu search}.

The First Fit algorithm cycles through all the planning entities,
initializing one planning entity at a time. 
It assigns the planning entity to the best available planning value, 
taking the already initialized planning entities into account.
It terminates when all entities have been initialized\cite{optaplannerDoc:heuristics}.

The Tabu Search metaheuristics search is based on local search optimization method
and enhances it by worse step strategy, 
when at each step worsening moves can be accepted if no improving move is available.
In addition, prohibitions are introduced to discourage the search from coming back to previously-visited solutions\cite{glover1989tabu}.

\subsection{Implementation}
Whole scheduling implementation can be found in module \inlinecode{core}.
Moreover, 
constraints are placed in package \inlinecode{pw.forst.olb.core.constraints}.
OptaPlanner related implementation is placed inside \inlinecode{pw.forst.olb.core.domain}
and plan solution evaluator in \inlinecode{pw.forst.olb.core.evaluation}.

All custom constraints should implement \inlinecode{CompletePlanEvaluation} 
or \inlinecode{PlanEvaluation} interface.
That way, 
they can be used in custom score evaluator,
which is then used to generate score of the given plan.
The constrains are stored in collections of previously mentioned interfaces 
and evaluated at once, when plan is submitted.
Thanks to this solution,
additional constrains can be added or removed very easily.

As an input for the scheduling algorithm interface \inlinecode{SchedulingProperties} is used.
This interface defines properties necessary for the scheduling infrastructure
such as \inlinecode{maxTimePlanningSpend} which defines how long can the application run the scheduling 
or \inlinecode{cores}, describing how many cores in the computer can algorithm utilize by spawning scheduling threads.

The OptaPlanner scheduler instance is created by custom factory implementation 
\inlinecode{OptaPlannerSolverFactory} and uses base configuration defined in \inlinedata{solverConfiguration.xml} file.
